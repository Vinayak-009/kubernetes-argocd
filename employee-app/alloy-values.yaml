alloy:
  configMap:
    content: |
      // =================================================================
      // 1. LOGGING PIPELINE (Loki)
      // =================================================================
      discovery.kubernetes "pods" {
        role = "pod"
      }

      discovery.relabel "pod_logs" {
        targets = discovery.kubernetes.pods.targets
        
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }
        // Match your app 'my-app'
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app"]
          regex         = "my-app"
          action        = "keep"
        }
      }

      loki.source.kubernetes "pod_logs_source" {
        targets    = discovery.relabel.pod_logs.output
        forward_to = [loki.process.severity_filter.receiver]
      }

      loki.process "severity_filter" {
        forward_to = [loki.write.default.receiver]
        stage.match {
          // Drop non-severe logs to save space
          selector = "{namespace!=\"monitoring\"} !~ \"(?i)(ERROR|CRITICAL|FATAL|SEVERE|HIGH)\""
          action   = "drop" 
        }
      }

      loki.write "default" {
        endpoint {
          url = "http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push"
        }
      }

      // =================================================================
      // 2. FLASK APP SCRAPER (The "my-app" Logic)
      // =================================================================
      discovery.relabel "flask_app" {
        targets = discovery.kubernetes.pods.targets
        
        // 1. Keep only my-app
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app"]
          regex         = "my-app" 
          action        = "keep"
        }
        
        // 2. Force Port 8080 (Critical for connection)
        rule {
          source_labels = ["__address__"]
          action        = "replace"
          regex         = "([^:]+)(?::\\d+)?"
          replacement   = "$1:8080"
          target_label  = "__address__"
        }
        
        // 3. Add Namespace & Pod labels
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }

        // 4. FORCE 'app' LABEL (Fixes the Empty Dropdown)
        rule {
          action       = "replace"
          replacement  = "my-app"
          target_label = "app"
        }
      }

      prometheus.scrape "flask_scrape" {
        targets    = discovery.relabel.flask_app.output
        forward_to = [prometheus.remote_write.default.receiver]
        job_name   = "flask-app"
      }

      // =================================================================
      // 3. INFRASTRUCTURE SCRAPER (CPU, Memory, Pod Status)
      // =================================================================
      discovery.kubernetes "nodes" {
        role = "node"
      }
      
      // Scrape Kubelet cAdvisor (This gives CPU/Memory data)
      discovery.relabel "cadvisor" {
        targets = discovery.kubernetes.nodes.targets
        rule {
          action = "replace"
          source_labels = ["__meta_kubernetes_node_address_InternalIP"]
          target_label  = "__address__"
          replacement   = "$1:10250"
        }
      }

      prometheus.scrape "cadvisor" {
        targets = discovery.relabel.cadvisor.output
        scheme  = "https"
        metrics_path = "/metrics/cadvisor"
        
        tls_config {
            ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
            insecure_skip_verify = true
        }
        bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
        
        forward_to = [prometheus.remote_write.default.receiver]
        job_name   = "cadvisor"
      }

      // =================================================================
      // 4. REMOTE WRITE DESTINATION
      // =================================================================
      prometheus.remote_write "default" {
        endpoint {
          url = "kube-stack-kube-prometheus-prometheus.monitoring.svc.cluster.local:9090/api/v1/write"
        }
      }