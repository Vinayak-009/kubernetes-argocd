alloy:
  configMap:
    content: |
      // =================================================================
      // 1. LOGGING PIPELINE (Loki)
      // =================================================================
      discovery.kubernetes "pods" {
        role = "pod"
      }

      discovery.relabel "pod_logs" {
        targets = discovery.kubernetes.pods.targets
        
        // Labeling for Grafana
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }
        // Capture the app label so the dashboard filter works
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app"]
          target_label  = "app"
        }
      }

      loki.source.kubernetes "pod_logs_source" {
        targets    = discovery.relabel.pod_logs.output
        forward_to = [loki.process.severity_filter.receiver]
      }

      loki.process "severity_filter" {
        forward_to = [loki.write.default.receiver]
        // TEMPORARILY REMOVED THE DROP FILTER TO ENSURE DATA FLOWS
        // We will add it back once we see logs in Grafana
      }

      loki.write "default" {
        endpoint {
          // Simplified URL
          url = "http://loki.monitoring:3100/loki/api/v1/push"
        }
      }

      // =================================================================
      // 2. METRICS PIPELINE (App & Infrastructure)
      // =================================================================
      discovery.relabel "flask_app" {
        targets = discovery.kubernetes.pods.targets
        rule { source_labels = ["__meta_kubernetes_pod_label_app"]; regex = "my-app"; action = "keep" }
        rule { source_labels = ["__address__"]; action = "replace"; regex = "([^:]+)(?::\\d+)?"; replacement = "$1:8080"; target_label = "__address__" }
        rule { source_labels = ["__meta_kubernetes_namespace"]; target_label = "namespace" }
        rule { source_labels = ["__meta_kubernetes_pod_name"]; target_label = "pod" }
        rule { action = "replace"; replacement = "my-app"; target_label = "app" }
      }

      prometheus.scrape "flask_scrape" {
        targets    = discovery.relabel.flask_app.output
        forward_to = [prometheus.remote_write.default.receiver]
        job_name   = "flask-app"
      }

      discovery.kubernetes "nodes" { role = "node" }
      discovery.relabel "cadvisor" {
        targets = discovery.kubernetes.nodes.targets
        rule { action = "replace"; source_labels = ["__meta_kubernetes_node_address_InternalIP"]; target_label = "__address__"; replacement = "$1:10250" }
      }

      prometheus.scrape "cadvisor" {
        targets = discovery.relabel.cadvisor.output
        scheme  = "https"
        metrics_path = "/metrics/cadvisor"
        tls_config { ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"; insecure_skip_verify = true }
        bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
        forward_to = [prometheus.remote_write.default.receiver]
      }

      prometheus.remote_write "default" {
        endpoint {
          url = "http://kube-stack-kube-prometheus-prometheus.monitoring:9090/api/v1/write"
        }
      }