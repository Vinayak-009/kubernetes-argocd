name: Build, Push and Update Manifest

on:
  push:
    branches:
      - main
    paths:
      - 'employee-app/**' # Only trigger if files in your app folder change

permissions:
  contents: write # Required to push the updated yaml back to the repo

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Create a 4-character Short SHA
    - name: Generate Short SHA
      run: echo "SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-4)" >> $GITHUB_ENV

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./employee-app        # <--- IMPORTANT: Your files are in this subfolder
        file: ./employee-app/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/employee-app:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/employee-app:${{ env.SHORT_SHA }}

    - name: Update Kubernetes Manifest
      run: |
        # Target the deploy.yaml INSIDE the employee-app folder
        # Replace image tag with the 4-char SHORT_SHA
        sed -i "s|image: .*|image: ${{ secrets.DOCKERHUB_USERNAME }}/employee-app:${{ env.SHORT_SHA }}|g" employee-app/deploy.yaml
        
        # Check for changes and push
        if [[ -n $(git status -s) ]]; then
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add employee-app/deploy.yaml
          git commit -m "Update image tag to ${{ env.SHORT_SHA }}"
          git push
        else
          echo "No changes to deploy.yaml"
        fi
